<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartDine - Your Orders</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles/style.css">
</head>

<body onload="checkAuth()">

<header class="site-header">
    <div class="header-inner">
        <a href="home.html" class="brand">SmartDine</a>
        <nav class="nav-links">
            <a href="home.html">Home</a>
            <a href="about.html">About Us</a>
            <div id="navRightArea">
                </div>
        </nav>
    </div>
</header>

<div class="order-page-container">
    <div class="page-header">
        Your Order List
        <div class="page-actions">
            <button class="btn-logout" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div id="orderListContent">
        <p class="empty-cart-message" id="emptyMessage">Your cart is empty! Time to Explore Menu.</p>
        <a href="restaurant.html" style="align-self:center; text-align: center; display: block; margin-top: 10px;">Click here to Explore Foods</a>
    </div>

    <div id="orderSummary" class="order-summary" style="display: none;">
        <div class="summary-row">
            <span>Subtotal:</span>
            <span id="subtotalValue">₹0.00</span>
        </div>
        <div class="summary-row">
            <span>Tax (5%):</span>
            <span id="taxValue">₹0.00</span>
        </div>
        <div class="summary-row total-row">
            <span>Total Amount:</span>
            <span id="totalValue">₹0.00</span>
        </div>
        
        <button class="btn-checkout" onclick="calculateTotalAndCheckout()">
            <i class="fas fa-credit-card"></i> Checkout
        </button>
    </div>
</div>

<script>
    const CART_KEY = 'cartItems';

    function getCartItems() {
        try {
            const cartData = sessionStorage.getItem(CART_KEY);
            return JSON.parse(cartData || '[]');
        } catch (e) {
            console.error("Error parsing cart data:", e);
            return [];
        }
    }

    function saveCartItems(cart) {
        sessionStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    function calculateTotalAndCheckout() {
        const cart = getCartItems();
        if (cart.length === 0) {
            alert("Your cart is empty. Please add items before checking out.");
            return;
        }

        let subtotal = 0;
        cart.forEach(item => {
            subtotal += item.price * item.quantity;
        });

        const taxRate = 0.05;
        const tax = subtotal * taxRate;
        const total = subtotal + tax;

        document.getElementById('subtotalValue').textContent = `₹${total.toFixed(2)}`;
        document.getElementById('taxValue').textContent = `₹${tax.toFixed(2)}`;
        document.getElementById('totalValue').textContent = `₹${total.toFixed(2)}`;

        alert(`Total amount calculated: ₹${total.toFixed(2)}. Proceeding to payment...`);
    }
    
    function removeItemFromCart(index) {
        let cart = getCartItems();
        
        if (index > -1 && index < cart.length) {
            cart.splice(index, 1);
            saveCartItems(cart);
            updateOrderList();
        } else {
            console.error("Invalid item index for removal:", index);
        }
    }

    function updateOrderList() {
        const cart = getCartItems();
        const contentDiv = document.getElementById('orderListContent');
        const summaryDiv = document.getElementById('orderSummary');

        if (cart.length === 0) {
            contentDiv.innerHTML = `
                <p class="empty-cart-message">Your cart is empty! Time to Explore Menu.</p>
                <a href="restaurant.html" style="align-self:center; text-align: center; display: block; margin-top: 10px;">Click here to Explore Foods</a>
            `;
            summaryDiv.style.display = 'none';
            return;
        }

        let subtotal = 0;
        let html = '';

        cart.forEach((item, index) => {
            const price = parseFloat(item.price) || 0;
            const quantity = parseInt(item.quantity) || 0;

            const itemTotal = price * quantity;
            subtotal += itemTotal;
            html += `
                <div class="order-item">
                    <div class="item-details">
                        <span class="item-name">${item.name}</span>
                        <span class="item-price-quantity">₹${price.toFixed(2)} x ${quantity}</span>
                    </div>
                    <div class="price-action">
                        <span class="item-total">₹${itemTotal.toFixed(2)}</span>
                        <button class="delete-btn" onclick="removeItemFromCart(${index})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        contentDiv.innerHTML = html;
        summaryDiv.style.display = 'block';

        const taxRate = 0.05;
        const tax = subtotal * taxRate;
        const total = subtotal + tax;

        document.getElementById('subtotalValue').textContent = `₹${subtotal.toFixed(2)}`;
        document.getElementById('taxValue').textContent = `₹${tax.toFixed(2)}`;
        document.getElementById('totalValue').textContent = `₹${total.toFixed(2)}`;
    }

    function getCartCount() {
        const cart = getCartItems();
        return cart.reduce((total, item) => total + (parseInt(item.quantity) || 0), 0);
    }

    function updateNavForUser() {
        const username = sessionStorage.getItem('username');
        const navRightArea = document.getElementById('navRightArea');
        const firstLetter = username ? username.charAt(0).toUpperCase() : 'U';

        if (username) {
            navRightArea.innerHTML = `
                <a href="restaurant.html" class="btn-order">Order Now</a>

                <a href="user.html" class="user-profile-icon" title="${username} Orders">
                    ${firstLetter}
                </a>
            `;
        } else {
            navRightArea.innerHTML = `
                <a href="restaurant.html" class="btn-order">Order Now</a>
                <a href="signin.html" class="user-profile-icon" title="Log In">
                    <i class="fas fa-user"></i>
                </a>
            `;
            window.location.href = 'signin.html';
        }
    }

    function checkAuth() {
        const username = sessionStorage.getItem('username');
        if (!username) {
            window.location.href = 'signin.html';
        } else {
            updateNavForUser();
            updateOrderList();
        }
    }

    function handleLogout() {
        sessionStorage.removeItem('username');
        window.location.href = 'signin.html';
    }
</script>

</body>
</html>